# Methods Section - Xenium Data Processing, Alignment, Transformation, and Visualization

## Post-Xenium confocal imaging

Following Xenium in situ profiling, tissue sections were imaged using a Leica SP8 confocal microscope equipped with a white light laser and spectral detection. To improve single-cell segmentation in plant tissues, which often display irregular polygonal geometries, cell wall autofluorescence was leveraged to define cellular boundaries. Lambda-lambda spectral scans were first performed to characterize tissue-specific autofluorescence and determine optimal excitation and emission settings. Fluorescence lifetime imaging microscopy (FLIM) was then used to capture fluorescence decay profiles, allowing separation of overlapping signals based on lifetime characteristics. Derived lifetime parameters were subsequently applied for tau gating and tau separation to suppress background autofluorescence and enhance cell wall contrast in full-section images. The resulting images were used to generate cell boundary masks for spatial transcriptomic segmentation.

## Registering of Xenium and cell wall images

Cell wall images obtained after the Xenium process exhibit changes in orientation, translation, scale and resolution when compared to the Xenium spatial reference frame. This necessitates an alignment of the cell wall images with respect to the Xenium reference frame for accurate localization of transcripts to cellular boundaries and efficient integration into subsequent analysis pipelines. The process, termed "registering" the images, involved obtaining transformation matrices to account for all geometric distortions, including but not limited to rotation, translation, scaling, and possibly affine transformations, and applying said transformation matrices to the cell wall images. Thus, creating registered cell wall images that are aligned with the Xenium coordinate system, and therefore retain the spatial relationships between transcript locations and the cell walls. In addition, the registered images preserve the physical distance information (micrometers per pixel) required for accurate transcript-to-cell assignments. [Quality control metrics, including edge-based normalized cross correlation and structural similarity index, were also employed to evaluate the quality of the registration - did you do so? If not, eliminate]. The registered cell wall images will be input into the subsequent segmentation steps to ensure that the cell boundaries are properly positioned relative to the transcript coordinates.

## Plant cell image segmentation

A key component of the accurate assignment of transcripts to spatially defined compartments within plant cells is the accurate delineation of plant cell boundaries. Due to their irregular and polygonal shape, the use of the Xenium pipeline's default method, which uses the DAPI channel to perform nuclei-based segmentation, is not suitable for plant tissues. Therefore, fluorescence images exhibiting inherent cell wall autofluorescence or derived from confocal microscopy cell wall signals were used as input to segment the cell walls using the Cellpose (version 4.0.7) deep learning-based segmentation algorithm [Add Ref]. When nucleus-level transcript assignment was sufficient, nuclear segmentation from the DAPI channel was used; otherwise, cell wall segmentation was utilized to obtain the precise cellular boundaries.

For cell wall segmentation, images were processed using Cellpose with the 'cpsam' model, which is optimized for cytoplasmic and cell boundary detection. Segmentation parameters were optimized for plant tissue characteristics: cell diameter estimates (typically 60-90 pixels [which have you used?], adjusted based on tissue type and image resolution) and minimum cell size threshold (15 pixels). The images were first converted to grayscale before segmentation, and for multi-dimensional image stacks, the maximum intensity projection was applied along the z axis. [Using the nuclei model, the DAPI channel was used to segment the nuclei, and the diameter estimates were determined based on the average nuclear size for the tissue type of interest - Describe as per Xenium process].

The segmentation pipeline accepts images in the OME-TIFF format and extracts the spatial metadata, including the micrometers per pixel (MPP) value from the the images to provide accurate scaling. Segmentation masks are created as labeled images, where each cell or nucleus is provided a unique integer ID. These masks are used to assign transcripts to cells, where the cell ID of each cell containing a transcript is identified by determining the segmented region that contains each transcript's spatial location. A detailed documentation of the scripts and tutorial for image segmentation and processing can be found at https://github.com/thiagomaf/PYcellsegmentation.

